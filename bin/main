#!/usr/bin/env ruby
# rubocop:disable Security/Open
require 'nokogiri'
require 'open-uri'
require 'json'
require 'tmpdir'
require_relative '../lib/house.rb'
require_relative '../lib/web.rb'

def show(house)
  puts "adds >> category : #{house.category}
  ** address : #{house.address}
  ** price : #{house.price} Ariary
  ** date : #{house.date}
  ** link : #{house.link}"
  puts '===================================================================='
end

def warning(house, old)
  puts "Warning: #{house[:category]} => The price has changed.
  \n Old price: #{old['price']} Ariary \t => New price #{house[:price]} Ariary"
end

houses = []
list_houses = Web.get_page.css('div.post')
par_page = list_houses.count
page = 1
total = Web.get_page.css('ul.tabset li:first-child a').text.tr('()', '').split(' ').last.to_i
last_page = (total / par_page).to_f.round
while page <= 1
  list_houses = Web.get_page(Web.url_setting(page)).css('div.post')

  puts "Page #{page}"
  puts Web.url_setting(page)
  list_houses.each do |house_listing|
    house = House.new(house_listing)
    houses << house.house_hash
    show(house)
  end
  page += 1
end

def temp
  tempfilename = File.join(Dir.tmpdir, 'search_result.json')
  File.zero?(tempfilename) ? File.new(tempfilename, 'w') : tempfilename
end

def check(houses, result_file = '../result/search_result.json')
  if File.exist?(result_file) && !File.zero?(result_file)
    old_results = JSON.parse(open(result_file).read)
    compare_results(old_results, houses)
  else
    File.new(result_file, 'w+')
  end

  File.open(result_file, 'w+') do |file|
    if result_file == '../result/search_result.json'
      file << JSON.generate(houses)
    else
      file.puts JSON.generate(houses)
    end
  end
end

def compare_results(old_results, houses)
  houses.each do |house|
    old = old_results.find { |old_result| house[:id] == old_result['id'] }

    unless old.nil?
      warning(house, old) if house[:price] != old['price']
    end
  end
end


if File.exist?('../result/search_result.json')
  check(houses)
else
  check(houses, temp)
end

# rubocop:enable Security/Open
